# pgtyped-model

> Not ðŸ‘ an ðŸ‘ ORM ðŸ‘ !

This library provides convenient interface for customizing queries generated by [pgTyped](https://github.com/adelsz/pgtyped).

If you find yourself defining functions to wrap each generated query with some repetitive boilerplate code, this library is for you.

## Features

âœ… &nbsp;Built-in flag to convert all column names to ðŸª `camelCase`

âœ… &nbsp;Map multiple queries to a unified data format (e.g. instantiate a class)

âœ… &nbsp;Customize individual queries using convenient helper functions (e.g. convert result of the query from array to an object)

âœ… &nbsp;Create multiple variations of the same query with different return types

âœ… &nbsp;Invoke a custom hook on each database query (useful for logging or debugging)

âœ… &nbsp;Only pass database connection once instead of passing it to each query

[â¬‡ï¸ Jump to examples](#Example)

## Installation

Using npm

```bash
npm install pgtyped-model
```

Using yarn

```bash
yarn add pgtyped-model
```

## Usage

### Recommended file structure

Assuming `Post` is one of the entities in your system:

```bash
Post
â”œâ”€â”€ Post.sql        # Hand-written SQL queries
â”œâ”€â”€ Post.queries.ts # File generated by PgTyped
â””â”€â”€ index.ts        # Define & export your model here
```

### Example

```typescript
// index.ts

import {
  // Main function
  createModel,

  // Optional helpers to transform query results
  takeOne,
  mapWith,
  groupWith,
  nestWith,
} from "pgtyped-model"
// Import client or pool instance from pg library
import {pool} from "./connection"
// Import generated queries
import * as queries from "./Post.queries"

export const PostModel = createModel({
  queries,
  connection: pool,
  camelCaseColumnNames: true,

  // Map rows of all queries to your format
  // Return type will be `Album[]`
  collectDefault: mapWith((row) => new Album(row)),

  // Override behavior for specific queries
  collect: {
    // This query is a JOIN of two entities Album and Track that have one-to-many relationship
    // Return type will be `AlbumWithTracks[]`
    listAlbumsWithTracks: nestWith("albumId", (rows) => {
      const tracks = rows.map((row) => new Track(row))
      return new AlbumWithTracks({...rows[0], tracks})
    }),
  },

  // Execute a custom hook on each query
  onQuery: ({queryName, params, rows, result}) => {
    console.table([
      {
        queryName,
        params: JSON.stringify(params),
        rowCount: rows.length,
      },
    ])
  },
}).extend({
  // Only return first row for this query.
  // Return type will be `Album | undefined` instead of Album[]
  getAlbum: takeOne(),

  // Index selected albums by `artistId` field
  // Return type will be `{
  //   [artistId: string]: Album[]
  // }`
  listAlbumsByArtistId: groupWith("artistId"),
})
```
